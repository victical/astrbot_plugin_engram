# Astrbot Engram 仿生双轨记忆系统

`astrbot_plugin_engram` 是一款为 Astrbot 设计的工业级长期记忆增强插件。它模仿人类大脑的记忆机制，通过“双轨制”架构解决了 LLM 在即时通讯场景下记忆碎片化、遗忘快、无法回溯原文等痛点。

## 🌟 核心特性

### 1. 仿生双轨记忆架构
- **叙事性归档 (L2 记忆)**：自动将零散的私聊对话总结为具备情感色彩的日记体长期记忆。
- **原文指针回溯 (Index-to-Raw)**：记忆不仅有摘要，还通过 UUID 指针精准关联原始对白。AI 回复时可直接调取“原话”，彻底消除幻觉。
- **时间线链表**：在数据库底层建立链表结构，使每一条记忆都带有“前情提要”，让 AI 具备因果感知能力。

### 2. 深度用户画像 (User Persona)
- **多维建模**：自动维护包含基础信息、性格特征、偏好、禁忌及关系状态的结构化画像。
- **每日深度构建**：系统会在每日凌晨自动回顾全天记忆，当信息积累达到阈值（可配置）时，触发一次深度的画像重塑。
- **上下文注入**：按照 `用户画像 > 长期记忆 > 当前上下文` 的优先级自动注入 System Prompt，实现极高的人格化交互。

### 3. 高性能与成本优化
- **全异步执行**：基于 `ThreadPoolExecutor` 和 `asyncio`，所有数据库 (SQLite) 和向量库 (ChromaDB) 操作均不阻塞主线程。
- **归档机制**：消息总结后自动标记为“已归档”，防止重复计算，最大限度节省 Token。
- **语义搜索**：基于向量检索 (ChromaDB)，支持模糊语义查询，而不仅仅是关键词匹配。

## 🛠️ 指令说明

| 指令 | 说明 |
| :--- | :--- |
| `/mem_list` | 查看最近生成的长期记忆 |
| `/mem_view <序号>` | 查看某条记忆背后的完整对话回溯（剧本模式） |
| `/mem_search <关键词>` | 搜索相关的长期记忆（含时间戳、背景及原文参考） |
| `/mem_clear_raw` | 清除未归档的原始对话原文（保留已生成的记忆） |
| `/mem_clear_archive` | 清除所有长期记忆归档（保留原始对话原文） |
| `/mem_clear_all` | 彻底清除所有长期记忆与原始对话（需二次确认） |
| `/profile show` | 查看当前的结构化用户画像（手账风格图片） |
| `/profile set <键> <值>` | 手动设置画像字段（如：`/profile set basic_info.job 学生`） |
| `/profile clear` | 重置用户画像（需二次确认） |
| `/engram_force_summarize` | (管理员) 立即对当前所有未处理对话进行记忆归档 |
| `/engram_force_persona` | (管理员) 立即基于今日记忆强制深度更新画像 |

## ⚙️ 配置项说明

在 Astrbot WebUI 的插件配置页面，您可以自定义以下参数：
- **私聊记忆总结触发时间**：距离最后一次对话超过此时间触发总结。
- **触发总结最少消息数**：未总结消息达到此数量才触发总结。
- **强制总结回溯天数限制**：控制记忆回溯的深度。设置为 7 表示仅总结最近 7 天的消息，更早的消息将被直接跳过（节省 Token）。默认为 0（无限制）。
- **总结记忆使用的模型**：支持下拉选择已配置的 LLM 提供商（建议使用低成本模型）。
- **画像更新阈值**：每日新增记忆达到多少条才触发画像深度更新。
- **自定义总结提示词**：支持自定义记忆提取逻辑。

## 🚀 安装

1. 在 Astrbot 插件市场搜索并安装。
2. 或手动克隆到 `data/plugins/` 目录：
   ```bash
   cd data/plugins
   git clone https://github.com/victical/astrbot_plugin_engram.git
   ```
3. 重启 Astrbot。

## 💡 致谢

- 用户信息的获取与解析参考了 [astrbot_plugin_box](https://github.com/Zhalslar/astrbot_plugin_box)。

## 🧪 功能测试指南

如果您需要验证插件的所有核心功能，请按照以下步骤操作：

### 1. 记忆录入与召回测试
- **第一步：建立记忆**。发送几条包含具体信息的私聊消息。例如：
  - `我最近在准备考研，压力好大。`
  - `我超级喜欢吃冰美式，但是不喜欢香菜。`
  - `我的猫叫奥利奥。`
- **第二步：触发归档**。根据您的配置（默认 30 分钟且 > 4 条消息），您可以等待超时，或者在测试时临时调小配置项中的 `private_memory_timeout` 为 `60`。
- **第三步：验证召回**。过一会后问 AI：`我刚才提到了什么？` 或者 `你知道我的猫叫什么吗？`
  - **预期结果**：AI 应该能在回复中正确回溯上述信息，并显示 `【长期记忆回溯】`。

### 2. 用户画像（全息侧写）测试
- **第一步：产生足够记忆**。确保今天有至少 3 条（由 `min_persona_update_memories` 决定）长期记忆生成。
- **第二步：模拟更新**。正常情况下画像在凌晨 00:00 更新。开发测试时，管理员可以使用 `/engram_force_persona` 立即触发。
- **第三步：查看画像**。输入 `/profile show`。
  - **预期结果**：手账图片中应在“记忆碎片”分类下看到提取出的标签，如“爱好”中出现 `冰美式`，“禁忌”中出现 `香菜`。底部“羁绊”应显示当前关系状态。

### 3. 语义搜索与列表测试
- 输入 `/mem_list`：应列出带有 ⏰ 时间和 📝 归档内容的记忆列表。
- 输入 `/mem_search 考研`：应精准召回带有 ⏰ 时间、📝 归档以及 └ 📄 相关原文参考的结果。

### 4. 动态交互注入测试
- **第一步**：手动设置一个职业：`/profile set basic_info.job 程序员`。
- **第二步**：随便发一条消息。
- **预期结果**：AI 的回复中如果涉及到职业话题，应该能意识到你是“程序员”。

## 📂 存储说明
本插件遵循 Astrbot 规范，所有持久化数据均存储在由 `StarTools.get_data_dir()` 自动生成的插件数据目录下（通常为 `data/plugins_data/astrbot_plugin_engram/`）：
- **SQLite**: `engram_memories.db` (存储原文、索引及时间链)。
- **ChromaDB**: `engram_chroma/` (存储语义向量)。
- **JSON Persona**: `engram_personas/{user_id}.json` (存储用户画像)。

## ⚠️ 常见问题
- **安装失败 (NotADirectoryError)**：如果您在上传 zip 安装时遇到此错误，请确保您的 zip 压缩包内**直接包含**插件文件（如 `main.py`, `metadata.yaml` 等），而不是将它们放在一个多层嵌套的文件夹中。
